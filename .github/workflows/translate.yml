name: Traduction conditionnelle multi-dossiers

on:
  push:
    branches:
      - test-translation  # Branche à surveiller pour les modifications
    # paths:
    #   - 'content/**'

jobs:
  translate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        ref: test-translation

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install google-genai

    - name: Trouver fichiers sans traduction
      id: find_missing
      run: |
        mapfile -t missing_files < <(bash .github/scripts/find_missing.sh)
        echo "Fichiers sans traduction trouvés: ${#missing_files[@]}"
        echo "files=${missing_files[*]}" >> $GITHUB_OUTPUT

    - name: Traduire fichiers modifiés
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        echo $GITHUB_OUTPUT
        echo "Fichiers à traduire: ${{ steps.find_files.outputs.files }}"
        for file in ${{ steps.find_files.outputs.files }}; do
          echo "Traduction: $file"
          python3 .github/scripts/translate.py "$file"
        done
        
    - name: Commit & push fichiers traduits
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add content/**/fr/** content/**/en/**
        git diff --cached --quiet || (git commit -m "Traductions automatiques via Gemini" && git push)
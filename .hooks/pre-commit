#!/bin/bash

set -e

MARKDOWN_DIR="."
ASSETS_SOURCE="../ASSETS"
ASSETS_DEST="$MARKDOWN_DIR/assets"

# Cr√©e le dossier destination s'il n'existe pas
mkdir -p "$ASSETS_DEST"

# Trouver tous les fichiers .md dans 3 - GARDEN (sous-dossiers inclus)
find "$MARKDOWN_DIR" -type f -name "*.md" | while read -r mdfile; do
  # Extraire toutes les r√©f√©rences du type ![[image.jpg]]
  grep -oP '!\[\[\K[^\]]+' "$mdfile" | while read -r image; do
    echo "üîç V√©rification de l'image '$image' dans '$mdfile'"
    src="$ASSETS_SOURCE/$image"
    dest="$ASSETS_DEST/$image"

    # Si le fichier image existe dans ASSETS
    if [[ -f "$src" ]]; then
      # S'il n'est pas d√©j√† copi√©
      if [[ ! -f "$dest" ]]; then
        echo "üì• Copie de '$image' vers '$ASSETS_DEST'"
        cp "$src" "$dest"
        git add "$dest"
      fi
    else
      echo "‚ùå Image manquante : '$image' r√©f√©renc√©e dans '$mdfile' mais absente de '$ASSETS_SOURCE'"
      echo "‚õî Commit annul√©."
      exit 1
    fi
  done
done

exit 0
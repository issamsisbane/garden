#!/bin/bash

set -e

MARKDOWN_DIR="."
ASSETS_SOURCE="../ASSETS"
ASSETS_DEST="$MARKDOWN_DIR/assets"

# Trouver tous les fichiers .md dans 3 - GARDEN (sous-dossiers inclus)
find "$MARKDOWN_DIR" -type f -name "*.md" | while read -r mdfile; do
  # Extraire toutes les r√©f√©rences du type ![[image.jpg]]
  grep -oP '!\[\[\K[^\]]+' "$mdfile" | while read -r image; do
    # echo "üîç V√©rification de l'image '$image' dans '$mdfile'"
    src="$ASSETS_SOURCE/$image"
    dest="$ASSETS_DEST/$image"

    # Si le fichier image existe dans ASSETS
    if [[ -f "$dest" ]]; then
      # S'il n'est pas d√©j√† copi√©
      if [[ ! -f "$src" ]]; then
        # echo "üì• Copie de '$image' vers '$ASSETS_DEST'"
        cp "$dest" "$src"
      fi
    else
      echo "‚ùå Image manquante : '$image' r√©f√©renc√©e dans '$mdfile' mais absente de '$ASSETS_SOURCE'"
      echo "‚õî Commit annul√©."
      exit 1
    fi
  done
done

echo "‚úÖ Toutes les images r√©f√©renc√©es ont √©t√© v√©rifi√©es et copi√©es si n√©cessaire."

exit 0
